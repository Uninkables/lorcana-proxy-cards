<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Lorcana Proxy Card Generator</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <h1>Lorcana Proxy Card Generator</h1>
  
<h2>Search Cards to Add</h2>

<div class="search-controls">
  <label class="rarity-toggle">
    <input type="checkbox" id="showHighRarity">
    <span class="slider"></span>
    <span class="toggle-text">Show Epic & Enchanted</span>
  </label>

  <input type="text" id="cardSearch" placeholder="Search for card..." />
</div>

<div id="searchResults"></div>

<h2>Selected Cards</h2>
<button class="btnPrimary" id="printSheetBtn">Generate Sheet</button>
<div id="selectedCards"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
<script>
let cards = [];
const selected = new Map();

fetch("cards.json")
  .then(r => r.json())
  .then(data => {
    cards = data;
  });

const searchInput = document.getElementById("cardSearch");
const resultsDiv = document.getElementById("searchResults");
const selectedDiv = document.getElementById("selectedCards");
const showHighRarityCheckbox = document.getElementById("showHighRarity");

searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  resultsDiv.innerHTML = "";

showHighRarityCheckbox.addEventListener("change", () => {
  searchInput.dispatchEvent(new Event("input"));
});
  
  if (!query) return;

  cards
    .filter(c => {
      const matchesSearch =
        `${c.name} - ${c.version}`.toLowerCase().includes(query);

      const blockedRarities = ["Epic", "Enchanted"];
      const isBlocked = blockedRarities.includes(c.rarity);
      
      const showHighRarity = showHighRarityCheckbox.checked;
  
      if (!showHighRarity && isBlocked) return false;
  
      return matchesSearch;
    })
    .slice(0, 20)
    .forEach(card => {
      const div = document.createElement("div");
      div.className = "search-result";
    
      const img = document.createElement("img");
      img.src = card.image_uris.digital.small;
      img.alt = `${card.name} - ${card.version}`;
      img.className = "search-thumb";
    
      const info = document.createElement("div");
      info.className = "card-info";
    
      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = `${card.name} - ${card.version}`;
    
      const sub = document.createElement("div");
      sub.className = "card-sub";
      sub.textContent = `${card.collector_number}/204 EN·${card.set.code}`;
    
      info.append(title, sub);
      const thumbWrapper = document.createElement("div");
      thumbWrapper.className = "thumb-wrapper";
      thumbWrapper.appendChild(img);
      
      div.append(thumbWrapper, info);
    
      div.onclick = () => addCard(card);
    
      resultsDiv.appendChild(div);
    });
});

function addCard(card) {
  const key = card.id;

  if (selected.has(key)) {
    selected.get(key).quantity += 1;
  } else {
    selected.set(key, { card, quantity: 1 });
  }

  renderSelected();
  resultsDiv.innerHTML = "";
  searchInput.value = "";
}

function renderSelected() {
  selectedDiv.innerHTML = "";

  for (const [key, data] of selected.entries()) {
    const { card, quantity } = data;

    const row = document.createElement("div");
    row.className = "selected-card";

    // Thumbnail
    const thumbWrapper = document.createElement("div");
    thumbWrapper.className = "thumb-wrapper";

    const img = document.createElement("img");
    img.src = card.image_uris.digital.small;
    img.className = "search-thumb";

    thumbWrapper.appendChild(img);

    // Info
    const info = document.createElement("div");
    info.className = "card-info";

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = `${card.name} - ${card.version}`;

    const sub = document.createElement("div");
    sub.className = "card-sub";
    sub.textContent = `${card.collector_number}/204 EN·${card.set.code}`;

    info.append(title, sub);

    // Quantity controls
    const qtyWrapper = document.createElement("div");
    qtyWrapper.className = "qty-wrapper";

    const minus = document.createElement("button");
    minus.textContent = "−";
    minus.className = "circle-btn";
    minus.onclick = () => updateQty(key, quantity - 1);

    const input = document.createElement("input");
    input.type = "number";
    input.min = "0";
    input.value = quantity;
    input.className = "qty-input";
    input.onchange = () =>
      updateQty(key, parseInt(input.value || 0, 10));

    const plus = document.createElement("button");
    plus.textContent = "+";
    plus.className = "circle-btn";
    plus.onclick = () => updateQty(key, quantity + 1);

    qtyWrapper.append(minus, input, plus);

    row.append(thumbWrapper, info, qtyWrapper);
    selectedDiv.appendChild(row);
  }
}

function updateQty(key, newQty) {
  if (newQty <= 0) {
    selected.delete(key);
  } else {
    selected.get(key).quantity = newQty;
  }

  renderSelected();
}

document.getElementById("printSheetBtn")
  .addEventListener("click", generatePrintSheet);

async function generatePrintSheet() {
  const { jsPDF } = window.jspdf;

  const expandedCards = [];

  for (const { card, quantity } of selected.values()) {
    for (let i = 0; i < quantity; i++) {
      expandedCards.push(card);
    }
  }

  if (expandedCards.length === 0) {
    alert("No cards selected.");
    return;
  }

  const doc = new jsPDF({
    orientation: "portrait",
    unit: "in",
    format: "letter"
  });

  const pageWidth = 8.5;
  const pageHeight = 11;

  const cardWidth = 2.46;
  const cardHeight = 3.45;

  const cols = 3;
  const rows = 3;
  const cardsPerPage = 9;

  // Center the 3x3 grid on page
  const totalGridWidth = cardWidth * cols;
  const totalGridHeight = cardHeight * rows;

  const startX = (pageWidth - totalGridWidth) / 2;
  const startY = (pageHeight - totalGridHeight) / 2;

  let cardIndex = 0;
  const totalPages = Math.ceil(expandedCards.length / cardsPerPage);

  for (let page = 0; page < totalPages; page++) {

    if (page > 0) doc.addPage();

    // ---- DRAW CUT LINES (extend full grid edges) ----
    doc.setLineWidth(0.01); // ~1px thin

    // Vertical lines
    for (let c = 0; c <= cols; c++) {
      const x = startX + c * cardWidth;
      doc.line(x, 0, x, pageHeight);
    }

    // Horizontal lines
    for (let r = 0; r <= rows; r++) {
      const y = startY + r * cardHeight;
      doc.line(0, y, pageWidth, y);
    }

    // ---- PLACE CARDS ----
    for (let row = 0; row < rows; row++) {
      for (let col = 0; col < cols; col++) {

        if (cardIndex >= expandedCards.length) break;

        const card = expandedCards[cardIndex];

        const x = startX + col * cardWidth;
        const y = startY + row * cardHeight;

        try {
          const imgData = await loadImageAsDataURL(
            card.image_uris.digital.normal
          );

          doc.addImage(
            imgData,
            "JPEG",
            x,
            y,
            cardWidth,
            cardHeight
          );
        } catch (e) {
          console.error("Image failed:", e);
        }

        cardIndex++;
      }
    }
  }

  doc.save("card-sheet.pdf");
}

function loadImageAsDataURL(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";

    img.onload = function () {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      resolve(canvas.toDataURL("image/jpeg"));
    };

    img.onerror = reject;
    img.src = url;
  });
}
  
</script>  
</body>
</html>


